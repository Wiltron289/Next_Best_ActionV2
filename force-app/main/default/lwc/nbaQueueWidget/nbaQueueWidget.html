<template>
    <template if:false={queueItem}>
        <div class="nba-widget-card" style={containerStyle}>
            <div class="nba-widget-header">
                <div class="nba-widget-title">Next Best Action</div>
            </div>
            <div class="nba-widget-body" style="text-align:center; padding: 40px 0;">
                <span style="font-size:2.5rem; color:#4bca81;">‚úîÔ∏è</span>
                <div style="font-size:1.2rem; font-weight:600; margin-top:12px;">You‚Äôre all caught up!</div>
                <div style="color:#888; margin-top:6px;">No pending actions at this time.</div>
            </div>
        </div>
    </template>
    <template if:true={queueItem}>
        <div class={widgetClass} style={containerStyle}>
            <div class="nba-widget-header">
                <div class="nba-widget-title">Next Best Action</div>
                <div class="nba-widget-header-actions">
                    <button class="nba-widget-refresh-btn" onclick={handleManualRefresh} title="Refresh Queue">
                        <span class="nba-widget-refresh-icon">üîÑ</span>
                    </button>
                </div>
            </div>
            <div class="nba-widget-body">
                <div class="nba-widget-row nba-widget-main-row">
                    <span class="nba-widget-icon">üìû</span>
                    <span class="nba-widget-main-text">
                        {actionText}
                        <a href="javascript:void(0);" class="nba-widget-link" onclick={handleRecordClick}> {recordName}</a>
                    </span>
                </div>
                
                <!-- Priority Score Display - Hidden -->
                <!-- <template if:true={showPriorityScore}>
                    <div class="nba-widget-row nba-widget-priority-row">
                        <div class="nba-widget-priority-score">
                            <span class="nba-widget-priority-label">Priority Score:</span>
                            <span class="nba-widget-priority-value {priorityScoreClass}">{priorityScoreDisplay}</span>
                            <template if:true={hasMultipliers}>
                                <span class="nba-widget-priority-original">(was {originalScoreDisplay})</span>
                                <span class="nba-widget-priority-multipliers">‚Ä¢ {multiplierText}</span>
                            </template>
                        </div>
                    </div>
                </template> -->
                
                <div class="nba-widget-row">
                    <template if:true={queueItem.Opportunity__c}>
                        <span class="nba-widget-badge nba-widget-badge-opportunity">{opportunityStage}</span>
                    </template>
                </div>

                <div class="nba-widget-row nba-widget-badges-row">
                    <template if:true={employeeCount}>
                        <span class="nba-widget-badge">{employeeCount} employees</span>
                    </template>
                    <template if:true={companyAgeMonths}>
                        <span class="nba-widget-badge">{companyAgeMonths} months old</span>
                    </template>
                </div>
                <div class="nba-widget-tabs">
                    <button value="contact" onclick={handleTabChange} class={contactTabClass}>Contact Info</button>
                    <button value="product" onclick={handleTabChange} class={productTabClass}>Product Usage</button>
                </div>
                <!-- Removed Opportunity details panel: this content now lives on the right panel of the console page -->
                <template if:true={isContactTab}>
                    <div class="nba-widget-contact">
                        <template if:true={displayContactPerson}>
                            <div class="nba-widget-detail-row">
                                <span class="nba-widget-detail-label">Best Person to Call</span>
                                <span class="nba-widget-detail-value">
                                    <a href="javascript:void(0);" class="nba-widget-link" onclick={handleContactClick} data-contact-id={displayContactId}>
                                        {displayContactPerson}
                                    </a>
                                </span>
                            </div>

                            <template if:true={displayContactEmail}>
                                <div class="nba-widget-detail-row">
                                    <span class="nba-widget-detail-label">Contact Email</span>
                                    <span class="nba-widget-detail-value">{displayContactEmail}</span>
                                </div>
                            </template>
                        </template>
                        <template if:true={displayContactPhone}>
                            <div class="nba-widget-detail-row">
                                <span class="nba-widget-detail-label">Best Number to Call</span>
                                <span class="nba-widget-detail-value">
                                    <a href="javascript:void(0);" class="nba-widget-link" onclick={handlePhoneClick} data-phone={displayContactPhone}>
                                        {displayContactPhone}
                                    </a>
                                </span>
                            </div>
                        </template>

                        <template if:false={displayContactPerson}>
                            <template if:false={displayContactPhone}>
                                <div class="nba-widget-contact-placeholder">No contact information available for this record.</div>
                            </template>
                        </template>
                    </div>
                </template>
                <template if:true={isProductTab}>
                    <div class="nba-widget-product">
                        <template if:true={hasProductUsage}>
                            <div class="nba-widget-product-grid">
                                <template if:true={queueItem.Break_Preferences_Engaged__c}>
                                    <div class="nba-widget-product-item">
                                        <span class="nba-widget-product-icon">‚è∞</span>
                                        <span class="nba-widget-product-label">Break Preferences</span>
                                    </div>
                                </template>
                                <template if:true={queueItem.Department_Management_Engaged__c}>
                                    <div class="nba-widget-product-item">
                                        <span class="nba-widget-product-icon">üè¢</span>
                                        <span class="nba-widget-product-label">Department Management</span>
                                    </div>
                                </template>
                                <template if:true={queueItem.Geofencing_Engaged__c}>
                                    <div class="nba-widget-product-item">
                                        <span class="nba-widget-product-icon">üìç</span>
                                        <span class="nba-widget-product-label">Geofencing</span>
                                    </div>
                                </template>
                                <template if:true={queueItem.Hiring_Engaged__c}>
                                    <div class="nba-widget-product-item">
                                        <span class="nba-widget-product-icon">üë•</span>
                                        <span class="nba-widget-product-label">Hiring</span>
                                    </div>
                                </template>
                                <template if:true={queueItem.Hrdocs_Engaged__c}>
                                    <div class="nba-widget-product-item">
                                        <span class="nba-widget-product-icon">üìã</span>
                                        <span class="nba-widget-product-label">HR Docs</span>
                                    </div>
                                </template>
                                <template if:true={queueItem.Manager_Log_Engaged__c}>
                                    <div class="nba-widget-product-item">
                                        <span class="nba-widget-product-icon">üìù</span>
                                        <span class="nba-widget-product-label">Manager Log</span>
                                    </div>
                                </template>
                                <template if:true={queueItem.Messaging_Engaged__c}>
                                    <div class="nba-widget-product-item">
                                        <span class="nba-widget-product-icon">üí¨</span>
                                        <span class="nba-widget-product-label">Messaging</span>
                                    </div>
                                </template>
                                <template if:true={queueItem.Mobile_Time_Tracking_Engaged__c}>
                                    <div class="nba-widget-product-item">
                                        <span class="nba-widget-product-icon">üì±</span>
                                        <span class="nba-widget-product-label">Mobile Time Tracking</span>
                                    </div>
                                </template>
                                <template if:true={queueItem.Oam_Activity__c}>
                                    <div class="nba-widget-product-item">
                                        <span class="nba-widget-product-icon">üîß</span>
                                        <span class="nba-widget-product-label">OAM Activity</span>
                                    </div>
                                </template>
                                <template if:true={queueItem.Overtime_Preferences_Engaged__c}>
                                    <div class="nba-widget-product-item">
                                        <span class="nba-widget-product-icon">‚è∞</span>
                                        <span class="nba-widget-product-label">Overtime Preferences</span>
                                    </div>
                                </template>
                                <template if:true={queueItem.Scheduling_Engaged__c}>
                                    <div class="nba-widget-product-item">
                                        <span class="nba-widget-product-icon">üìÖ</span>
                                        <span class="nba-widget-product-label">Scheduling</span>
                                    </div>
                                </template>
                                <template if:true={queueItem.Shift_Notes_Engaged__c}>
                                    <div class="nba-widget-product-item">
                                        <span class="nba-widget-product-icon">üìù</span>
                                        <span class="nba-widget-product-label">Shift Notes</span>
                                    </div>
                                </template>
                                <template if:true={queueItem.Shift_Trades_Engaged__c}>
                                    <div class="nba-widget-product-item">
                                        <span class="nba-widget-product-icon">üîÑ</span>
                                        <span class="nba-widget-product-label">Shift Trades</span>
                                    </div>
                                </template>
                                <template if:true={queueItem.Time_Offs_Engaged__c}>
                                    <div class="nba-widget-product-item">
                                        <span class="nba-widget-product-icon">üèñÔ∏è</span>
                                        <span class="nba-widget-product-label">Time Offs</span>
                                    </div>
                                </template>
                                <template if:true={queueItem.Time_Tracking_Engaged__c}>
                                    <div class="nba-widget-product-item">
                                        <span class="nba-widget-product-icon">‚è±Ô∏è</span>
                                        <span class="nba-widget-product-label">Time Tracking</span>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template if:false={hasProductUsage}>
                            <div class="nba-widget-product-placeholder">No product usage data available for this record.</div>
                        </template>
                    </div>
                </template>
            </div>
            
            <!-- Call Disposition Form -->
            <template if:true={showCallDispositionForm}>
                <div class="nba-widget-form-section">
                    <div class="nba-widget-form-header">
                        <h3>Call Disposition</h3>
                        <button class="nba-widget-form-close" onclick={closeCallDispositionForm}>√ó</button>
                    </div>
                    <div class="nba-widget-form-content">
                        <div class="nba-widget-form-field">
                            <label>Phone Number Called</label>
                            <div class="nba-widget-form-value">{currentPhoneNumber}</div>
                        </div>
                        <div class="nba-widget-form-field">
                            <label for="call-disposition">Call Disposition *</label>
                            <select id="call-disposition" class="nba-widget-form-select" onchange={handleCallDispositionChange} value={callDisposition} required>
                                <option value="">Select disposition...</option>
                                <template for:each={callDispositionOptions} for:item="option">
                                    <option key={option.value} value={option.value}>{option.label}</option>
                                </template>
                            </select>
                        </div>
                        <template if:true={hasOpportunity}>
                            <div class="nba-widget-form-field">
                                <label for="stage-update">Opportunity Stage Update</label>
                                <select id="stage-update" class="nba-widget-form-select" onchange={handleStageChange} value={selectedStage}>
                                    <template for:each={opportunityStageOptions} for:item="opt">
                                        <option key={opt.value} value={opt.value}>{opt.label}</option>
                                    </template>
                                </select>
                            </div>
                        </template>
                        <div class="nba-widget-form-field">
                            <label for="call-notes">Call Notes</label>
                            <textarea id="call-notes" class="nba-widget-form-textarea" oninput={handleCallNotesChange} value={callNotes} placeholder="Enter call notes..."></textarea>
                        </div>
                        <template if:true={showNextStepsFields}>
                            <div class="nba-widget-form-field">
                                <label for="next-step-date">Next Step Date</label>
                                <input type="date" id="next-step-date" class="nba-widget-form-textarea" oninput={handleNextStepDateChange} value={nextStepDate} />
                            </div>
                            <div class="nba-widget-form-field">
                                <label for="next-step">Next Step</label>
                                <textarea id="next-step" class="nba-widget-form-textarea" oninput={handleNextStepsChange} value={nextSteps} placeholder="Enter next step..."></textarea>
                            </div>
                        </template>
                        <div class="nba-widget-form-actions">
                            <button class="nba-widget-form-cancel" onclick={closeCallDispositionForm}>Cancel</button>
                            <button class="nba-widget-form-save" onclick={handleCallDispositionSave} disabled={isLoading}>
                                Save
                            </button>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Dismiss Form -->
            <template if:true={showDismissForm}>
                <div class="nba-widget-form-section">
                    <div class="nba-widget-form-header">
                        <h3>Dismiss Reason</h3>
                        <button class="nba-widget-form-close" onclick={closeDismissForm}>√ó</button>
                    </div>
                    <div class="nba-widget-form-content">
                        <div class="nba-widget-form-field">
                            <label for="dismissal-category">Dismissal Category *</label>
                            <select id="dismissal-category" class="nba-widget-form-select" onchange={handleDismissalCategoryChange}>
                                <option value="">Select...</option>
                                <option value="Call Scheduled">Call Scheduled</option>
                                <option value="Time Zone">Time Zone</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <template if:true={isCallScheduled}>
                            <div class="nba-widget-form-field">
                                <label for="snooze-datetime">When is the Call Scheduled?</label>
                                <input id="snooze-datetime" type="datetime-local" class="nba-widget-form-textarea" oninput={handleSnoozeScheduledAtChange} />
                            </div>
                        </template>
                        <template if:true={isTimeZoneSnooze}>
                            <div class="nba-widget-form-field">
                                <label for="snooze-hours">Snooze for how many hours?</label>
                                <input id="snooze-hours" type="number" min="1" class="nba-widget-form-textarea" oninput={handleSnoozeHoursChange} />
                            </div>
                        </template>
                        <template if:true={isOtherDismissal}>
                            <div class="nba-widget-form-field">
                                <label for="dismiss-reason">Reason for Dismissal</label>
                                <textarea id="dismiss-reason" class="nba-widget-form-textarea" oninput={handleDismissReasonChange} value={dismissReason} placeholder="Enter reason..."></textarea>
                            </div>
                        </template>
                        <div class="nba-widget-form-actions">
                            <button class="nba-widget-form-cancel" onclick={closeDismissForm}>Cancel</button>
                            <button class="nba-widget-form-save" onclick={submitDismissReason} disabled={isLoading}>
                                Submit
                            </button>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Footer Actions (only show when no forms are active) -->
            <template if:false={showCallDispositionForm}>
                <template if:false={showDismissForm}>
                    <div class="nba-widget-footer">
                        <button class="nba-widget-skip" data-id={queueItem.Id} onclick={handleDismissAction}>Skip</button>
                        <button class="nba-widget-call" data-id={queueItem.Id} onclick={handleAcceptAction}>Accept</button>
                    </div>
                </template>
            </template>
        </div>
    </template>

</template>