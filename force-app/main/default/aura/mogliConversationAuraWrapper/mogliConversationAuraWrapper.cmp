<aura:component implements="flexipage:availableForAllPageTypes,flexipage:availableForRecordHome,force:hasRecordId" controller="NBAQueueManager" access="global">
    <aura:attribute name="recordId" type="Id"/>
    <aura:attribute name="simpleRecord" type="Object"/>
    <aura:attribute name="opportunityId" type="Id"/>
    <aura:attribute name="personRecordId" type="Id"/>
    <aura:attribute name="subscription" type="Object"/>
    <aura:attribute name="mogliVisible" type="Boolean" default="true"/>
    <aura:attribute name="refreshKey" type="String" default="initial"/>
    <aura:attribute name="debug" type="Boolean" default="true"/>
    <aura:attribute name="testRecordId" type="String" description="Optional: static Contact/Opportunity Id for testing fallback"/>

    <aura:handler name="init" value="{!this}" action="{!c.init}"/>
    <aura:handler name="change" value="{!v.simpleRecord}" action="{!c.handleRecordUpdated}"/>
    <aura:handler name="destroy" value="{!this}" action="{!c.cleanup}"/>

    <!-- LMS wiring -->
    <lightning:messageService aura:id="messageService"/>
    <lightning:messageChannel aura:id="opportunityContext" type="c__NBA_OpportunityContext__c"/>

    <!-- If this component is placed on an NBA_Queue__c record page, load Opportunity__c and Lead__c -->
    <force:recordData
            aura:id="recordLoader"
            recordId="{!v.recordId}"
            targetFields="{!v.simpleRecord}"
            fields="NBA_Queue__c.Opportunity__c,NBA_Queue__c.Lead__c"
            recordUpdated="{!c.handleRecordUpdated}"/>

    <!-- Prefer person/contact/lead id; fallback to Opportunity id; final fallback to testRecordId -->
    <aura:if isTrue="{!v.mogliVisible}">
        <div aura:id="{!v.refreshKey}">
            <aura:if isTrue="{!NOT(empty(v.personRecordId))}">
                <Mogli_SMS:TextMessageComponentEmpApi recordId="{!v.personRecordId}"/>
                <aura:set attribute="else">
                    <aura:if isTrue="{!NOT(empty(v.opportunityId))}">
                        <Mogli_SMS:TextMessageComponentEmpApi recordId="{!v.opportunityId}"/>
                        <aura:set attribute="else">
                            <aura:if isTrue="{!NOT(empty(v.testRecordId))}">
                                <Mogli_SMS:TextMessageComponentEmpApi recordId="{!v.testRecordId}"/>
                                <aura:set attribute="else">
                                    <div class="slds-text-color_error slds-p-around_small">
                                        No person/lead or opportunity found to pass to Mogli.
                                    </div>
                                </aura:set>
                            </aura:if>
                        </aura:set>
                    </aura:if>
                </aura:set>
            </aura:if>
        </div>
    </aura:if>

    <!-- Debug panel -->
    <aura:if isTrue="{!v.debug}">
        <div class="slds-text-color_weak slds-p-around_xx-small slds-text-body_small">
            Debug â€” Opportunity Id: {!v.opportunityId} | Person/Lead Id: {!v.personRecordId} | Test Id: {!v.testRecordId} | Refresh Key: {!v.refreshKey}
        </div>
    </aura:if>
</aura:component>


